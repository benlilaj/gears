<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">

<!--
Copyright 2007, Google Inc.

Redistribution and use in source and binary forms, with or without 
modification, are permitted provided that the following conditions are met:

 1. Redistributions of source code must retain the above copyright notice, 
    this list of conditions and the following disclaimer.
 2. Redistributions in binary form must reproduce the above copyright notice,
    this list of conditions and the following disclaimer in the documentation
    and/or other materials provided with the distribution.
 3. Neither the name of Google Inc. nor the names of its contributors may be
    used to endorse or promote products derived from this software without
    specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED
WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF 
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO
EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, 
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR 
OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF 
ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->

<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>Google Gears API Developer's Guide - WorkerPool API</title>


<!-- Begin Templates -->
<link rel="stylesheet" type="text/css" href="http://code.google.com/css/dev_docs.css" /> 
<link rel="stylesheet" type="text/css" href="./local_extensions.css" /> 
<!--[if IE 7]><link rel="stylesheet" type="text/css" href="http://code.google.com/css/ie7only.css" /><![endif]-->
<!--[if lte IE 6]><link rel="stylesheet" type="text/css" href="http://code.google.com/css/ie6only.css" /><![endif]-->
<!--[if IE]><link rel="stylesheet" type="text/css" href="http://code.google.com/css/ieonly.css" />  <![endif]-->
<!-- End Templates -->
</head>
<body id="api_workerpool_page">
<a name="top" id="top"></a>
<!-- ########## PAGE HEADER ########## -->
<div id="header">

<div id="logo">
<a href="http://code.google.com/"><img src="resources/code_sm.png"  alt="Google Code" width="150" height="55" border="0" /></a></div>

<h1 id="doc_title">Google Gears API Developer's Guide (Beta)</h1>

<ul class="trail">
<li>Google Code Home</li> &gt;
<!-- <li><a href="http://code.google.com/">Google Code Home</a></li> &gt; -->
<li><a href="api_summary.html">Gears API Reference</a></li> 
&gt;
<li>WorkerPool Module</li>
</ul>
</div>
<!-- ########## END PAGE HEADER ########## -->

<div id="wrapper">

<!-- ########## SIDE NAVIGATION ########## -->

<div id="sidenav">
  <script src="nav.js"></script>
</div>
<!-- ########## END SIDE NAVIGATION ########## -->




<!-- ########## PAGE CONTENT ########## -->
<div id="pagecontent">

<h1 id="page_title">WorkerPool Module API</h1>

<p>The WorkerPool module allows web applications to run JavaScript code
in the background, without blocking the main page's script execution.


<h3>Contents</h3>

  <ol class="toc">
  <li><a href="#overview">Overview</a>
    <ol>
    <li><a href="#isolation">Code and data isolation</a>
    <li><a href="#limitations">Limitations</a>
    <li><a href="#typical_use">Usage pattern</a>
    </ol>
  <li><a href="#workerpool_class">WorkerPool class</a>
  </ol>



<a name="overview" id="overview"></a>
<h2>Overview</h2>

<p>In web browsers a single time-intensive operation, such as I/O or
heavy computation, can make the UI unresponsive.  The WorkerPool module
runs operations in the background, without blocking the UI.
Scripts executing in the WorkerPool will not trigger the browser's
"unresponsive script" dialog.


<a name="isolation" id="isolation"></a>
<h3>Code and data isolation</h3>

<p>The WorkerPool behaves like a collection of processes, rather than threads.
<b>Workers do not share any execution state.</b>  Changing a variable in
one worker has no effect in any other worker.  And created workers do not
automatically inherit script code from their parents.

<p>Members of a WorkerPool interact with each other only by sending message
strings. Workers can also pass richer data types, by first converting objects
to strings using <a href="http://www.json.org/">JSON</a>.


<a name="limitations" id="limitations"></a>
<h3>Limitations</h3>

<p>A created worker does not have access to the DOM; objects like
<code>document</code> and <code>window</code> exist only on the main page.
This is a consequence of workers not sharing any execution state.

<p>However, workers do have access to all JavaScript built-in functions.  Most
Google Gears methods can also be used, through a global variable that is
automatically defined: <code>google.gears.factory</code>.  (One exception is
the LocalServer file submitter, which requires the DOM.)  For other
functionality, created workers can ask the main page to carry out requests.


<a name="typical_use" id="typical_use"></a>
<h3>Usage pattern</h3>

<p>To understand how to use the WorkerPool module, it is useful to look at
a typical example.

  <h4>Initialization sequence</h4>

<ol>
<li>JavaScript code (the "parent" worker) uses <code>google.gears.factory</code>
    to create a WorkerPool <code>wp</code>.
<li>The parent indicates where incoming messages should go by setting
    <code>wp.onmessage</code>.  It does this <i>before</i> calling
    <code>createWorker()</code> to ensure that no messages will be lost.
<li>For each new worker (a "child" worker):

  <ol class="alpha">
  <li>The parent calls <code>wp.createWorker()</code> with the full body of
       script that the child will contain.
  <li>Before <code>wp.createWorker()</code> returns, the child runs through its
      script once.  During this time the child must set its
      <code>onmessage</code> handler, on the predefined global variable
      <code>google.gears.workerPool</code>.
  <li>When the child returns, the parent and child begin running in parallel.
  </ol>
</ol>

  <h4>Communication</h4>

<p>Workers send strings to each other using <code>sendMessage()</code>.
Any member of a particular WorkerPool can communicate with any other member.  
  
<p>Each sent message triggers the receiver's <code>onmessage</code> handler.
Message events are handled like all other JavaScript events.  In particular,
processing is interleaved the same way: there is an event queue, and the next
event handler is not called until the previous one returns.

<p>The WorkerPool is <i>not</i> a singleton.  A page can create multiple
WorkerPool instances, and these pools are isolated from each other.  This
enables multiple gadgets on a page, for example, to use the WorkerPool module
without fear of collision.
  

<p>How does script know which worker ID to send messages to?  There are two
common ways:

<ol>
<li>Use the second parameter to <code>onmessage</code>, which contains the
    sender's worker ID.  A "grunt" worker whose purpose is to <u>execute
    requests asynchronously</u> will often use this method, blindly
    responding to whichever worker made the request.
<li>Use the value returned by <code>createWorker()</code>, which is the ID
    of the newly created worker.  A worker whose purpose is to <u>coordinate
    tasks</u> (usually the application's "main" JavaScript code) will often use
    this method.  The ID can be sent to, and used by, any member of the
    WorkerPool, but this is seldom necessary.
</ol>




<a name="workerpool_class" id="workerpool_class"></a>
<h2>WorkerPool class</h2>

<pre><code>callback <b>onmessage</b>(messageString, srcWorkerId)
int  <b>createWorker</b>(fullScript)
void <b>sendMessage</b>(messageString, destWorkerId)</code></pre>
<br>

<p>To create a WorkerPool object, use the Gears Factory as follows:</p>
<pre><code>&lt;script type="text/javascript" src="<a href='tools.html#gears_init'>gears_init.js</a>"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
var workerPool = google.gears.factory.create('beta.workerpool', '1.1');
&lt;/script&gt;</code></pre>


<h3>Event Handler </h3>
<table>
  <tr class="odd">
    <th colspan="2"><div align="left"><code>callback onmessage(messageString, srcWorkerId)</code></div></th>
  </tr>
  <tr class="odd">
    <td>Description:</td>
    <td class="odd">Specifies the function to be called when this worker receives a message.</td>
  </tr>
  <tr class="odd">
    <td width="113">Parameters:</td>
    <td width="489" class="odd"><span class="code">messageString
                                       </span>- the message to send<span class="code"> <br />
                                       srcWorkerId - </span>ID of the source worker
    </td>
  </tr>
</table>

<h3>Methods</h3>
<table>
  <tr class="odd">
    <th colspan="2"><div align="left"><code>createWorker(fullScript)</code></div></th>
  </tr>
  <tr class="odd">
    <td width="113">Return value: </td>
    <td width="489">worker ID </td>
  </tr>
  <tr class="odd">
    <td>Parameters:</td>
    <td class="odd"><span class="code">fullScript</span><span class="code"> <br />
    </span></td>
  </tr>
  <tr class="odd">
    <td>Exceptions:</td>
    <td class="" >    </td>
  </tr>
  <tr class="odd">
    <td>Description:</td>
    <td class="odd">
      Creates a worker with <span class="code">fullScript</span> as the entire body of code for that worker.
      <br><br>
      Returns the ID of the new worker.
      <br><br>
      Worker IDs are guaranteed to be unique values that are never reused within the same WorkerPool.
      <br><br>
      The code provided in <span class="code">fullScript</span>  is guaranteed to run once before
      <span class="code">createWorker()</span> returns. &nbsp;The code must set an <span class="code">onmessage</span>
      handler during that time, otherwise the worker will never receive messages.
      <br><br>
      Two global objects are inserted into the namespace of every created worker:<br>
      &bull; <span class="code">google.gears.factory</span> - Provides a Factory for the worker.<br>
      &bull; <span class="code">google.gears.workerPool</span> - Gives access to the WorkerPool that created the worker.<br>
    </td>
  </tr>
</table>
<table>
  <tr class="odd">
    <th colspan="2"><code>void sendMessage(messageString, destWorkerId)</code></th>
  </tr>
  <tr class="odd">
    <td width="113">Return value: </td>
    <td width="489"><code>void</code></td>
  </tr>
  <tr class="odd">
    <td>Parameters:</td>
    <td class="odd">
      <span class="code">messageString</span>- the message to send
      <br />
      <span class="code">destWorkerId</span> - ID of the destination worker
    </td>
  </tr>
  <tr class="odd">
    <td>Exceptions:</td>
    <td class="" ></td>
  </tr>
  <tr class="odd">
    <td>Description:</td>
    <td class="odd">
      <p>Sends <code>messageString</code> to the  <span name="st">worker specified by <span class="code">destWorkerId</span> </span>.
      <p>Messages must be strings.
      <p>Messages sent from worker 1 to worker 2 in a particular order will be received in the same order.</p>
      <p>Messages can be sent and received only between members of the same WorkerPool. </p></td>
  </tr>
</table>

</div><!-- end page content -->
<!-- ########## END PAGE CONTENT ########## -->
</div><!-- end wrapper -->
<!-- ########## PAGE FOOTER ########## -->
<div id="footer">

<div id="footerlogo">
<img src="resources/art.gif" alt="Google color balls" />
</div>

<div>
    <p id="copyright">&copy;2007 Google -
	<a href="http://gears.google.com/tos.html">Terms of Service</a>
	</p>
  </div>

</div><!--end footer -->
<!-- ########## END PAGE FOOTER ########## -->



<!-- ########## ANALYTICS ########## -->
<script src="https://ssl.google-analytics.com/urchin.js" type="text/javascript"></script>
<script type="text/javascript">
  _uacct = "UA-18071-1";
  _uanchor=1;
  urchinTracker();
</script>
<!-- ########## END ANALYTICS ########## -->
</body></html>
