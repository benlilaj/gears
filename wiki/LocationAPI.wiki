#summary Provides means to fetch the location of a device running a Web browser with Gears.
= Introduction =

The purpose of this API is to provide means to fetch the location of a device running a Web browser with Gears.


= Description =

The Location API is an abstraction for the various location APIs that currently exist on mobile platforms (GPS-based, network/cellid-based). The API consists of the Location class, which encapsulates various location attributes (latitude, longitude, etc), and also provides the means to query the platform for a fresh location fix, or the last known fix. This API also provides a way to watch the location as it changes over time.

Location implementations can be straightforward mappings to native APIs (e.g the [http://www.forum.nokia.com/document/Cpp_Developers_Library/GUID-96C272CA-2BED-4352-AE7C-E692B193EC06/html/Location_Acquisition_APIIndexPage.html S60 Location Acquisition API]) or have a more complex design that combines several location providers (e.g a GPS-based provider and a cell id-based provider) and returns the location from the most accurate provider at any given time.


= API Goals =

  * One-shot location requests (eg, for recommendations sites -- "where am I right now?")
  * Repeated location updates (eg, for providing guided tours)
  * Ability to get the last-known position cheaply before doing an expensive new request
  * Compatibility with future use as a singleton in the standard DOM (eg window.geoLocation)
  * Ability to use alternative location service providers

= Examples = 

{{{
// Get the current location
var loc = google.gears.factory.create( "beta.location");
loc.get(function(result) {
  if (!result.errorCode) {
    updateMap(result.latitude, result.longitude);
  }
});
}}}

{{{
// Watch the location over time
var loc = google.gears.factory.create( "beta.location");
var watchId = loc.watch(function(result) {
  updateMap(result.latitude, result.longitude, result.accuracy);
});

loc.clearWatch(watchId);
}}}

{{{
// Only get the location if the last known location is more than a minute old
var now = new Date().getTime();
var threshold = now - 60000;

if (loc.lastKnownLocation &&
    loc.lastKnownLocation.timestamp.getTime() > threshold) {
  updateMap(loc.lastKnownLocation);
} else {
  loc.get(function(result) {
    updateMap(result);
  });
}
}}}

= Detailed API specification =

{{{
interface GearsLocation {
  // No location providers were available to serve this request. This might happen
  // if locationProviderUrl is set to null and the device does not have access to
  // any other type of providers (e.g. GPS).
  const short ERROR_NO_PROVIDER_AVAILABLE = 1;

  // A provider error has occured. This could be a hardware error with a GPS provider
  // or a protocol error with a network provider.
  const short ERROR_PROVIDER_FAILURE = 2

  // The user is in an area where a location fix cannot be provided.
  // This might happen, for example, if a WiFi-based provider is
  // in use and there are no WiFi networks around. It might also 
  // happen if a Cell-ID based provider cannot map the user's
  // network tower identifier to a location.
  const short ERROR_NOT_IN_RANGE = 3;

  // last-known position - null if there is no last known position
  readonly LocationResult lastKnownLocation;

  // Get the current location
  void get(LocationCallback callback, optional LocationOptions);

  // Watch the current location over time
  int watch(LocationCallback callback, optional LocationOptions);

  // Stop watching the current location
  void clearWatch(int watchId);
};

interface LocationOptions {
  // If set, the application would prefer the highest accuracy possible, regardless of
  // battery, cost, etc. This might mean, for example, to use the GPS radio instead of
  // cell id lookups. If not specified, the default value is false. The implementation
  // always has the last word on which mechanism to use, this is just a way for an
  // application to express a preference.
  bool highAccuracyDesired;

  // If set, specifies the URL to contact to convert location signals into a location. This
  // defaults to a Google service, but can be overridden to point elsewhere. If set to
  // null, no service will be used and a location will only be provided if the device has
  // native access to location data (eg GPS).
  string locationProviderUrl;
};

interface WatchLocationOptions : LocationOptions {
  // The frequency that the application desires updates on the position, in milliseconds.
  // The implementation will attempt to provide this rate, but may provide slower
  // updates to conserve battery, if it cannot get fixes, or if the user rejects use of the
  // required hardware.
  bool desiredUpdateRate;
};

void LocationCallback(LocationResult event);

interface Location {
  readonly decimal latitude; // latitude in degrees
  readonly decimal longitude; // longitude in degrees
  readonly Date timestamp;
  // Horizontal accuracy in meters representing 
  // the readius of the circular Earth surface with 
  // the center at (latitude, longitude). The actual user
  // location could be anywhere in this area.
  readonly int horizontalAccuracy;
};

interface LocationResult : Location {
  readonly int errorCode;
  readonly string errorMessage; // human readable, suitable for logs
};
}}}

= Location Provider Protocol =

Many devices do not have native access to GPS or other location data. Additionally, GPS can take a long time to start up, drains battery, and does not work indoors. Because of these problems, the location API also has the ability to send various signals that the devices has access to (nearby cell sites, wifi nodes, etc) to a third-party _location service provider_, who can resolve the signals into a location estimate.

The protocol between the device and the location service provider is HTTP POST, and the format is JSON. The client supports persistent HTTP cookies, but the cookie are *not* shared with the browser's cookie jar for privacy reasons.

== Request Format ==

The request uses an HTTP POST method with JSON contents.

|| *Name* || *Description* || *Required* || *Type" ||
|| version || The protocol version. Currently, this is "1.0". || Yes || string ||
|| host || The host of the web page that is requesting the location. || Yes || string ||
|| device_id || Globally unique device ID, generated by Gears. _TODO: Do we need this? Would a cookie suffice?_ || Yes || string ||
|| home_network_code || Home mobile network code. _TODO: Can somebody explain what this is better?_ || No || int ||
|| home_country_code || Home mobile country code. _TODO: Can somebody explain what this is better?_ || No || int ||
|| radio_type || Mobile radio type. _TODO: Can somebody expand on why this is necessary/useful?_ || No || string (gsm|cdma|wcdma) ||
|| cell_towers || Array of cell-id data objects. See description of cell-id below. || If wifi_data not present || array ||
|| wifi_towers || Array of wifi-id data objects. See description of wifi-id below. || If cellid_data not present || array ||

=== Cell-Id data elements ===

|| *Name* || *Description* || *Required* || *Type" ||
|| cell_id || Unique identifier of the cell. || Yes || string ||
|| area_code || _TODO: explanation required_ || Yes || int ||
|| network_code || _TODO: explanation required_ || No || int ||
|| country_code || _TODO: explanation required_ || No || int ||
|| age || Number of milliseconds since this cell was primary. If zero, this cell is primary currently. || No || int ||
|| signal_strength || Radio signal strength measured age seconds ago.  _TODO: What is the unit? Please tell me it is "bars", as in the cingular commercial :-)_. || No || int ||
|| timing_advance || Timing advance measured age seconds ago. _TODO: More explanation would be nice._ || No || int ||

=== Wifi-Id data elements ===

|| *Name* || *Description* || *Required* || *Type" ||
|| mac_address || The mac address of the wifi node. || Yes || string ||
|| signal_strength || Current signal strength. _TODO: What are the units?_ || No || int ||


= Alternatives =

An alternative to the locationProviderUrl property is to add more elements to the Location interface with all the signals required by location providers. For example, we could add an arrays of !CellTower and !WifiTower objects to the location object. A !JavaScript author could then tie all this information together with a location provider, creating a unified API.


= Privacy =

It must be clear to users when an application is using the Location API. The dialog that currently enables Gears general access should not also enable access to the location API. It would be too easy for users to forget that they allowed access to Gears, or to fail to realize that enabling Gears also also enables location access. At a minimum, there should be a separate dialog from the Gears access dialog to enable Location API access.  

It would also be interesting, though, to have some persistent UI that indicates that the location API is being used. For example, there could be a rotating globe or an icon of a map overlayed on the content area. Perhaps this UI should be 'active' somehow, indicating that something is happening, so that the user cannot forget that it is being used.